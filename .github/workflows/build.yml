name: Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Build exe
        run: python -m PyInstaller patreon_credits.spec --noconfirm

      - name: Build installer
        run: iscc installer\patreon_credits.iss

      - name: Upload standalone exe
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/PatreonCredits.exe

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: dist/installer/*.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Build app
        run: python -m PyInstaller patreon_credits.spec --noconfirm

      - name: Create DMG
        run: |
          APP_NAME="Patreon Credits Generator"
          VERSION="${GITHUB_REF_NAME:-dev}"
          DMG_DIR="dist/dmg"
          DMG_OUTPUT="dist/PatreonCredits_${VERSION}_macos.dmg"

          mkdir -p "$DMG_DIR"
          cp -R "dist/${APP_NAME}.app" "$DMG_DIR/"
          ln -s /Applications "$DMG_DIR/Applications"
          cp .env.example "$DMG_DIR/"

          hdiutil create -volname "$APP_NAME" \
            -srcfolder "$DMG_DIR" \
            -ov -format UDZO \
            "$DMG_OUTPUT"

          rm -rf "$DMG_DIR"

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2 libgirepository1.0-dev libcairo2-dev \
            libwebkit2gtk-4.1-dev gir1.2-webkit2-4.1

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Build binary
        run: python -m PyInstaller patreon_credits.spec --noconfirm

      - name: Create AppImage
        run: |
          VERSION="${GITHUB_REF_NAME:-dev}"
          ARCH="x86_64"
          APPDIR="dist/PatreonCredits.AppDir"

          mkdir -p "$APPDIR/usr/bin"
          mkdir -p "$APPDIR/usr/share/icons/hicolor/256x256/apps"

          cp dist/PatreonCredits "$APPDIR/usr/bin/PatreonCredits"
          chmod +x "$APPDIR/usr/bin/PatreonCredits"
          cp .env.example "$APPDIR/usr/bin/"

          cat > "$APPDIR/PatreonCredits.desktop" << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=Patreon Credits Generator
          Comment=Generate scrolling credits videos for Patreon supporters
          Exec=PatreonCredits
          Icon=PatreonCredits
          Categories=AudioVideo;Video;
          Terminal=false
          EOF

          cat > "$APPDIR/AppRun" << 'APPRUN'
          #!/usr/bin/env bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          exec "${HERE}/usr/bin/PatreonCredits" "$@"
          APPRUN
          chmod +x "$APPDIR/AppRun"

          # Generate placeholder icon
          python -c "
          from PIL import Image, ImageDraw
          img = Image.new('RGBA', (256, 256), (255, 66, 77, 255))
          d = ImageDraw.Draw(img)
          d.text((60, 90), 'PC', fill=(255, 255, 255))
          img.save('$APPDIR/PatreonCredits.png')
          img.save('$APPDIR/usr/share/icons/hicolor/256x256/apps/PatreonCredits.png')
          "

          # Download appimagetool
          curl -fSL -o appimagetool \
            "https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool

          ARCH="$ARCH" ./appimagetool "$APPDIR" \
            "dist/PatreonCredits_${VERSION}_linux_${ARCH}.AppImage" --no-appstream

          rm -rf "$APPDIR" appimagetool

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: dist/*.AppImage

  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/windows-exe/PatreonCredits.exe
            artifacts/windows-installer/*.exe
            artifacts/macos-dmg/*.dmg
            artifacts/linux-appimage/*.AppImage
