<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patreon Credits Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&family=Arvo:ital,wght@0,400;0,700;1,400;1,700&family=Bangers&family=Bebas+Neue&family=Cinzel:wght@400;700&family=Crimson+Text:wght@400;700&family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Josefin+Sans:ital,wght@0,100..700;1,100..700&family=LXGW+WenKai:wght@300;400;700&family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Libre+Baskerville:ital,wght@0,400..700;1,400..700&family=Lora:ital,wght@0,400..700;1,400..700&family=M+PLUS+Rounded+1c:wght@400;700&family=Merriweather:wght@400;700&family=Montserrat:wght@400;700&family=Neuton:ital,wght@0,200;0,300;0,400;0,700;0,800;1,400&family=Noto+Sans:wght@400;700&family=Noto+Serif+SC:wght@400;700&family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Oswald:wght@400;700&family=Pacifico&family=Permanent+Marker&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Playwrite+DE+Grund:wght@100..400&family=Poppins:wght@400;700&family=Quicksand:wght@400;700&family=Raleway:wght@400;700&family=Roboto:ital,wght@0,100..900;1,100..900&family=Rubik:ital,wght@0,300..900;1,300..900&family=Shippori+Mincho:wght@400;700&family=Source+Sans+3:wght@400;700&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background-color: #2a2a2a;
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #ff424d;
            position: relative;
        }

        .header-link {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 700;
            font-size: 14px;
            padding: 8px 16px;
            border-radius: 5px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .api-link {
            left: 20px;
            background-color: #4a9eff;
            color: #fff;
        }

        .api-link:hover {
            background-color: #3a8eef;
            transform: translateY(calc(-50% - 2px));
        }

        .settings-link {
            left: 120px;
            background-color: #666;
            color: #fff;
        }

        .settings-link:hover {
            background-color: #777;
            transform: translateY(calc(-50% - 2px));
        }

        .bmc-link {
            right: 20px;
            background-color: #FFDD00;
            color: #000;
        }

        .bmc-link:hover {
            background-color: #e6c700;
            transform: translateY(calc(-50% - 2px));
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #ccc;
            font-size: 1rem;
        }
        
        .container {
            flex: 1;
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .form-section {
            background-color: #2a2a2a;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #ff424d;
        }
        
        textarea, input[type="number"], select {
            width: 100%;
            padding: 12px;
            background-color: #1a1a1a;
            border: 1px solid #444;
            border-radius: 5px;
            color: #fff;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
        }
        
        select {
            cursor: pointer;
        }
        
        textarea:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #ff424d;
        }
        
        .options-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .options-row .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .button-container {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        button {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: #ff424d;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #e63946;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: #444;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #555;
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .status-section {
            background-color: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
        }
        
        .status-section.active {
            display: block;
        }
        
        .status-message {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #444;
            border-top-color: #ff424d;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .video-preview {
            background-color: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
            display: none;
        }
        
        .video-preview.active {
            display: block;
        }
        
        .video-preview h3 {
            margin-bottom: 15px;
            color: #ff424d;
        }
        
        video {
            width: 100%;
            max-width: 720px;
            border-radius: 10px;
            margin: 0 auto;
            display: block;
        }
        
        .download-section {
            margin-top: 20px;
            text-align: center;
        }
        
        .download-btn {
            background-color: #28a745;
            color: white;
            padding: 12px 40px;
            text-decoration: none;
            border-radius: 5px;
            display: inline-block;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .download-btn:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        
        .error-message {
            background-color: #dc3545;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .error-message.active {
            display: block;
        }
        
        .info-box {
            background-color: #1a1a1a;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .info-box h4 {
            color: #ff424d;
            margin-bottom: 10px;
        }
        
        .info-box p {
            color: #ccc;
            line-height: 1.6;
        }
        
        .patron-count {
            color: #ff424d;
            font-weight: 600;
        }
        
        .style-section {
            background-color: #1a1a1a;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .style-section h4 {
            color: #ff424d;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .style-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .style-group {
            flex: 1;
            min-width: 120px;
        }
        
        .style-group label {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        input[type="color"] {
            width: 100%;
            height: 40px;
            padding: 5px;
            cursor: pointer;
        }

        .font-preview {
            margin-top: 10px;
            padding: 10px 15px;
            background-color: #111;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 18px;
            color: #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="/api/docs" target="_blank" rel="noopener" class="header-link api-link">API Docs</a>
        <a href="/settings" class="header-link settings-link">Settings</a>
        <h1>üé¨ Patreon Credits Generator</h1>
        <p>Create professional scrolling credits for your YouTube videos</p>
        <a href="https://buymeacoffee.com/mscrnt" target="_blank" rel="noopener" class="header-link bmc-link">‚òï Buy me a coffee</a>
    </div>
    
    <div class="container">
        <div class="error-message" id="errorMessage"></div>
        
        <div class="form-section">
            <form id="creditsForm">
                <div class="form-group">
                    <label for="message">Custom Message</label>
                    <textarea id="message" rows="3" placeholder="This video was made possible by our amazing Patreon supporters:">This video was made possible by our amazing Patreon supporters:</textarea>
                </div>
                
                <div class="form-group">
                    <label for="customNames">Custom Names (optional)</label>
                    <textarea id="customNames" rows="4" placeholder="Enter names manually, one per line ‚Äî overrides Patreon list"></textarea>
                    <div style="display: flex; align-items: center; gap: 12px; margin-top: 4px;">
                        <p style="color: #888; font-size: 0.8rem; margin: 0;">Leave empty to use Patreon patron list.</p>
                        <label style="display: inline-flex; align-items: center; gap: 4px; cursor: pointer; background: #444; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; color: #ccc; margin: 0;">
                            Upload .txt/.csv
                            <input type="file" id="namesFileInput" accept=".txt,.csv" style="display: none;">
                        </label>
                    </div>
                </div>

                <div class="style-section">
                    <h4>Message Styling</h4>
                    <div class="style-controls">
                        <div class="style-group">
                            <label for="messageSize">Size</label>
                            <input type="number" id="messageSize" min="10" max="100" value="36">
                        </div>
                        <div class="style-group">
                            <label for="messageColor">Color</label>
                            <input type="color" id="messageColor" value="#ffffff">
                        </div>
                        <div class="style-group">
                            <label for="messageFont">Font</label>
                            <select id="messageFont">
                                <optgroup label="CJK + Latin (Chinese/Japanese/Korean)">
                                    <option value="noto_sans" selected>Noto Sans CJK</option>
                                    <option value="noto_serif_cjk">Noto Serif CJK</option>
                                    <option value="lxgw_wenkai">LXGW WenKai</option>
                                    <option value="zen_maru_gothic">Zen Maru Gothic</option>
                                    <option value="mplus_rounded">M PLUS Rounded 1c</option>
                                    <option value="shippori_mincho">Shippori Mincho</option>
                                </optgroup>
                                <optgroup label="Sans-serif (Latin only)">
                                    <option value="inter">Inter</option>
                                    <option value="roboto">Roboto</option>
                                    <option value="open_sans">Open Sans</option>
                                    <option value="poppins">Poppins</option>
                                    <option value="montserrat">Montserrat</option>
                                    <option value="raleway">Raleway</option>
                                    <option value="quicksand">Quicksand</option>
                                    <option value="source_sans">Source Sans 3</option>
                                    <option value="lato">Lato</option>
                                    <option value="nunito">Nunito</option>
                                    <option value="rubik">Rubik</option>
                                    <option value="dm_sans">DM Sans</option>
                                    <option value="josefin_sans">Josefin Sans</option>
                                    <option value="ubuntu">Ubuntu</option>
                                    <option value="oswald">Oswald</option>
                                    <option value="bebas_neue">Bebas Neue</option>
                                </optgroup>
                                <optgroup label="Serif (Latin only)">
                                    <option value="cinzel">Cinzel</option>
                                    <option value="playfair_display">Playfair Display</option>
                                    <option value="merriweather">Merriweather</option>
                                    <option value="crimson_text">Crimson Text</option>
                                    <option value="lora">Lora</option>
                                    <option value="libre_baskerville">Libre Baskerville</option>
                                    <option value="arvo">Arvo</option>
                                    <option value="neuton">Neuton</option>
                                </optgroup>
                                <optgroup label="Display (Latin only)">
                                    <option value="alfa_slab_one">Alfa Slab One</option>
                                    <option value="bangers">Bangers</option>
                                </optgroup>
                                <optgroup label="Handwriting/Script (Latin only)">
                                    <option value="permanent_marker">Permanent Marker</option>
                                    <option value="pacifico">Pacifico</option>
                                    <option value="playwrite">Playwrite DE Grund</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="style-group">
                            <label for="messageAlign">Align</label>
                            <select id="messageAlign">
                                <option value="left" selected>Left</option>
                                <option value="center">Center</option>
                                <option value="right">Right</option>
                                <option value="justify">Justified</option>
                            </select>
                        </div>
                        <div class="style-group">
                            <label>&nbsp;</label>
                            <div class="checkbox-group" style="margin-top: 0;">
                                <input type="checkbox" id="messageBold" checked>
                                <label for="messageBold" style="margin: 0;">Bold</label>
                            </div>
                        </div>
                    </div>
                    <div class="font-preview" id="messageFontPreview" style="font-family: 'Noto Sans', sans-serif; font-weight: bold;">The quick brown fox jumps over the lazy dog</div>
                </div>

                <div class="style-section">
                    <h4>Patron Names Styling</h4>
                    <div class="style-controls">
                        <div class="style-group">
                            <label for="patronSize">Size</label>
                            <input type="number" id="patronSize" min="10" max="60" value="20">
                        </div>
                        <div class="style-group">
                            <label for="patronColor">Color</label>
                            <input type="color" id="patronColor" value="#FFD700">
                        </div>
                        <div class="style-group">
                            <label for="patronFont">Font</label>
                            <select id="patronFont">
                                <optgroup label="CJK + Latin (Chinese/Japanese/Korean)">
                                    <option value="noto_sans" selected>Noto Sans CJK</option>
                                    <option value="noto_serif_cjk">Noto Serif CJK</option>
                                    <option value="lxgw_wenkai">LXGW WenKai</option>
                                    <option value="zen_maru_gothic">Zen Maru Gothic</option>
                                    <option value="mplus_rounded">M PLUS Rounded 1c</option>
                                    <option value="shippori_mincho">Shippori Mincho</option>
                                </optgroup>
                                <optgroup label="Sans-serif (Latin only)">
                                    <option value="inter">Inter</option>
                                    <option value="roboto">Roboto</option>
                                    <option value="open_sans">Open Sans</option>
                                    <option value="poppins">Poppins</option>
                                    <option value="montserrat">Montserrat</option>
                                    <option value="raleway">Raleway</option>
                                    <option value="quicksand">Quicksand</option>
                                    <option value="source_sans">Source Sans 3</option>
                                    <option value="lato">Lato</option>
                                    <option value="nunito">Nunito</option>
                                    <option value="rubik">Rubik</option>
                                    <option value="dm_sans">DM Sans</option>
                                    <option value="josefin_sans">Josefin Sans</option>
                                    <option value="ubuntu">Ubuntu</option>
                                    <option value="oswald">Oswald</option>
                                    <option value="bebas_neue">Bebas Neue</option>
                                </optgroup>
                                <optgroup label="Serif (Latin only)">
                                    <option value="cinzel">Cinzel</option>
                                    <option value="playfair_display">Playfair Display</option>
                                    <option value="merriweather">Merriweather</option>
                                    <option value="crimson_text">Crimson Text</option>
                                    <option value="lora">Lora</option>
                                    <option value="libre_baskerville">Libre Baskerville</option>
                                    <option value="arvo">Arvo</option>
                                    <option value="neuton">Neuton</option>
                                </optgroup>
                                <optgroup label="Display (Latin only)">
                                    <option value="alfa_slab_one">Alfa Slab One</option>
                                    <option value="bangers">Bangers</option>
                                </optgroup>
                                <optgroup label="Handwriting/Script (Latin only)">
                                    <option value="permanent_marker">Permanent Marker</option>
                                    <option value="pacifico">Pacifico</option>
                                    <option value="playwrite">Playwrite DE Grund</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="style-group">
                            <label>&nbsp;</label>
                            <div class="checkbox-group" style="margin-top: 0;">
                                <input type="checkbox" id="patronBold">
                                <label for="patronBold" style="margin: 0;">Bold</label>
                            </div>
                        </div>
                    </div>
                    <div class="font-preview" id="patronFontPreview" style="font-family: 'Noto Sans', sans-serif; font-weight: normal; color: #FFD700;">The quick brown fox jumps over the lazy dog</div>
                </div>

                <div class="options-row">
                    <div class="form-group">
                        <label for="duration">Video Duration (seconds)</label>
                        <input type="number" id="duration" min="5" max="60" value="15">
                    </div>
                    
                    <div class="form-group">
                        <label for="resolution">Resolution</label>
                        <select id="resolution">
                            <option value="1280x720" selected>720p HD (1280x720)</option>
                            <option value="1920x1080">1080p Full HD (1920x1080)</option>
                            <option value="3840x2160">4K UHD (3840x2160)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="columns">Columns</label>
                        <select id="columns">
                            <option value="1">1 Column</option>
                            <option value="2">2 Columns</option>
                            <option value="3">3 Columns</option>
                            <option value="4" selected>4 Columns</option>
                            <option value="5">5 Columns</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="nameAlign">Name Alignment</label>
                        <select id="nameAlign">
                            <option value="left" selected>Left</option>
                            <option value="center">Center</option>
                            <option value="right">Right</option>
                        </select>
                    </div>

                    <div class="form-group" style="max-width: 100px;">
                        <label for="truncateLength">Max Name Length</label>
                        <input type="number" id="truncateLength" min="0" max="50" value="15" title="0 = no truncation">
                    </div>

                    <div class="form-group" style="max-width: 120px;">
                        <label for="bgColor">Background</label>
                        <input type="color" id="bgColor" value="#000000">
                    </div>
                </div>

                <div class="options-row" style="gap: 30px;">
                    <div class="checkbox-group">
                        <input type="checkbox" id="wordWrap">
                        <label for="wordWrap" style="margin: 0;">Word wrap names</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="nameSpacing">
                        <label for="nameSpacing" style="margin: 0;">Line break between names</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="useCache">
                        <label for="useCache" style="margin: 0;">Use cached patron list</label>
                    </div>
                </div>
                
                <div class="button-container">
                    <button type="submit" class="btn-primary" id="generateBtn">
                        Generate Credits Video
                    </button>
                    <button type="button" class="btn-secondary" id="refreshBtn">
                        Refresh Patron List
                    </button>
                </div>
            </form>
            
            <div class="info-box">
                <h4>‚ÑπÔ∏è Information</h4>
                <p>Current patron count: <span class="patron-count" id="patronCount">Loading...</span></p>
                <p>FFmpeg status: <span id="ffmpegStatus">Checking...</span>
                    <button id="installFfmpegBtn" style="display:none; margin-left:8px; padding:2px 10px; font-size:0.85em; cursor:pointer; background:#28a745; color:#fff; border:none; border-radius:4px;" onclick="installFfmpeg()">Install</button>
                </p>
            </div>
        </div>
        
        <div class="status-section" id="statusSection">
            <div class="status-message">
                <div class="spinner"></div>
                <span id="statusText">Generating credits video...</span>
            </div>
        </div>
        
        <div class="video-preview" id="videoPreview">
            <h3>üìπ Preview</h3>
            <video id="videoPlayer" controls></video>
            <div class="download-section">
                <a href="#" class="download-btn" id="downloadBtn">Download Video</a>
                <a href="#" class="download-btn" id="openFolderBtn" style="display:none; background-color:#4a9eff; margin-left:10px;">Open Video Folder</a>
            </div>
        </div>
    </div>
    
    <script>
        const form = document.getElementById('creditsForm');
        const generateBtn = document.getElementById('generateBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const statusSection = document.getElementById('statusSection');
        const statusText = document.getElementById('statusText');
        const videoPreview = document.getElementById('videoPreview');
        const videoPlayer = document.getElementById('videoPlayer');
        const downloadBtn = document.getElementById('downloadBtn');
        const openFolderBtn = document.getElementById('openFolderBtn');
        const isDesktop = window.pywebview !== undefined;
        const errorMessage = document.getElementById('errorMessage');
        const patronCount = document.getElementById('patronCount');
        const ffmpegStatus = document.getElementById('ffmpegStatus');
        
        // Font family mapping (backend key -> CSS font-family)
        const fontFamilyMap = {
            'noto_sans': "'Noto Sans', sans-serif",
            'noto_serif_cjk': "'Noto Serif SC', serif",
            'lxgw_wenkai': "'LXGW WenKai', cursive",
            'zen_maru_gothic': "'Zen Maru Gothic', sans-serif",
            'mplus_rounded': "'M PLUS Rounded 1c', sans-serif",
            'shippori_mincho': "'Shippori Mincho', serif",
            'inter': "'Inter', sans-serif",
            'roboto': "'Roboto', sans-serif",
            'open_sans': "'Open Sans', sans-serif",
            'poppins': "'Poppins', sans-serif",
            'montserrat': "'Montserrat', sans-serif",
            'raleway': "'Raleway', sans-serif",
            'quicksand': "'Quicksand', sans-serif",
            'source_sans': "'Source Sans 3', sans-serif",
            'lato': "'Lato', sans-serif",
            'nunito': "'Nunito', sans-serif",
            'rubik': "'Rubik', sans-serif",
            'dm_sans': "'DM Sans', sans-serif",
            'josefin_sans': "'Josefin Sans', sans-serif",
            'ubuntu': "'Ubuntu', sans-serif",
            'oswald': "'Oswald', sans-serif",
            'bebas_neue': "'Bebas Neue', sans-serif",
            'cinzel': "'Cinzel', serif",
            'playfair_display': "'Playfair Display', serif",
            'merriweather': "'Merriweather', serif",
            'crimson_text': "'Crimson Text', serif",
            'lora': "'Lora', serif",
            'libre_baskerville': "'Libre Baskerville', serif",
            'arvo': "'Arvo', serif",
            'neuton': "'Neuton', serif",
            'alfa_slab_one': "'Alfa Slab One', serif",
            'bangers': "'Bangers', system-ui",
            'permanent_marker': "'Permanent Marker', cursive",
            'pacifico': "'Pacifico', cursive",
            'playwrite': "'Playwrite DE Grund', cursive"
        };

        // ---- localStorage persistence ----
        const STORAGE_KEY = 'patreon_credits_settings';

        // IDs of all form fields to persist
        const persistFields = [
            { id: 'message',       type: 'value' },
            { id: 'customNames',   type: 'value' },
            { id: 'messageSize',   type: 'value' },
            { id: 'messageColor',  type: 'value' },
            { id: 'messageFont',   type: 'value' },
            { id: 'messageBold',   type: 'checked' },
            { id: 'messageAlign',  type: 'value' },
            { id: 'patronSize',    type: 'value' },
            { id: 'patronColor',   type: 'value' },
            { id: 'patronFont',    type: 'value' },
            { id: 'patronBold',    type: 'checked' },
            { id: 'duration',      type: 'value' },
            { id: 'resolution',    type: 'value' },
            { id: 'columns',       type: 'value' },
            { id: 'nameAlign',     type: 'value' },
            { id: 'truncateLength', type: 'value' },
            { id: 'wordWrap',      type: 'checked' },
            { id: 'nameSpacing',   type: 'checked' },
            { id: 'bgColor',       type: 'value' },
            { id: 'useCache',      type: 'checked' },
        ];

        function saveSettings() {
            const settings = {};
            persistFields.forEach(f => {
                const el = document.getElementById(f.id);
                settings[f.id] = f.type === 'checked' ? el.checked : el.value;
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
        }

        function loadSettings() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            try {
                const settings = JSON.parse(raw);
                persistFields.forEach(f => {
                    if (settings[f.id] === undefined) return;
                    const el = document.getElementById(f.id);
                    if (f.type === 'checked') el.checked = settings[f.id];
                    else el.value = settings[f.id];
                });
            } catch (_) { /* ignore corrupt data */ }
        }

        // Restore on page load
        loadSettings();

        // Save whenever any tracked field changes
        persistFields.forEach(f => {
            const el = document.getElementById(f.id);
            el.addEventListener('change', saveSettings);
            if (el.type === 'color' || el.tagName === 'TEXTAREA') {
                el.addEventListener('input', saveSettings);
            }
        });

        // ---- Live font preview updaters ----
        function updateFontPreview(previewId, fontSelectId, boldCheckboxId, colorInputId) {
            const preview = document.getElementById(previewId);
            const fontVal = document.getElementById(fontSelectId).value;
            const bold = document.getElementById(boldCheckboxId).checked;
            preview.style.fontFamily = fontFamilyMap[fontVal] || 'sans-serif';
            preview.style.fontWeight = bold ? 'bold' : 'normal';
            if (colorInputId) {
                preview.style.color = document.getElementById(colorInputId).value;
            }
        }

        // Bind change events for message styling
        document.getElementById('messageFont').addEventListener('change', () =>
            updateFontPreview('messageFontPreview', 'messageFont', 'messageBold', 'messageColor'));
        document.getElementById('messageBold').addEventListener('change', () =>
            updateFontPreview('messageFontPreview', 'messageFont', 'messageBold', 'messageColor'));
        document.getElementById('messageColor').addEventListener('input', () =>
            updateFontPreview('messageFontPreview', 'messageFont', 'messageBold', 'messageColor'));

        // Bind change events for patron styling
        document.getElementById('patronFont').addEventListener('change', () =>
            updateFontPreview('patronFontPreview', 'patronFont', 'patronBold', 'patronColor'));
        document.getElementById('patronBold').addEventListener('change', () =>
            updateFontPreview('patronFontPreview', 'patronFont', 'patronBold', 'patronColor'));
        document.getElementById('patronColor').addEventListener('input', () =>
            updateFontPreview('patronFontPreview', 'patronFont', 'patronBold', 'patronColor'));

        // Sync previews with (possibly restored) values
        updateFontPreview('messageFontPreview', 'messageFont', 'messageBold', 'messageColor');
        updateFontPreview('patronFontPreview', 'patronFont', 'patronBold', 'patronColor');

        // Check FFmpeg status on load
        checkFFmpeg();
        updatePatronCount();
        
        async function checkFFmpeg() {
            const installBtn = document.getElementById('installFfmpegBtn');
            try {
                const response = await fetch('/check-ffmpeg');
                const data = await response.json();
                ffmpegStatus.textContent = data.installed ? '‚úÖ Installed' : '‚ùå Not installed';
                ffmpegStatus.style.color = data.installed ? '#28a745' : '#dc3545';
                installBtn.style.display = data.installed ? 'none' : 'inline-block';
            } catch (error) {
                ffmpegStatus.textContent = '‚ùå Error checking';
                ffmpegStatus.style.color = '#dc3545';
                installBtn.style.display = 'none';
            }
        }

        async function installFfmpeg() {
            const btn = document.getElementById('installFfmpegBtn');
            btn.disabled = true;
            btn.textContent = 'Installing...';
            ffmpegStatus.textContent = '‚è≥ Downloading FFmpeg...';
            ffmpegStatus.style.color = '#ffc107';
            try {
                const resp = await fetch('/install-ffmpeg', { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    ffmpegStatus.textContent = '‚úÖ Installed';
                    ffmpegStatus.style.color = '#28a745';
                    btn.style.display = 'none';
                } else {
                    ffmpegStatus.textContent = '‚ùå Install failed: ' + (data.error || 'Unknown error');
                    ffmpegStatus.style.color = '#dc3545';
                    btn.textContent = 'Retry';
                    btn.disabled = false;
                }
            } catch (error) {
                ffmpegStatus.textContent = '‚ùå Install failed';
                ffmpegStatus.style.color = '#dc3545';
                btn.textContent = 'Retry';
                btn.disabled = false;
            }
        }
        
        async function updatePatronCount() {
            try {
                const response = await fetch('/patron-count');
                const data = await response.json();
                patronCount.textContent = data.count || '0';
            } catch (error) {
                patronCount.textContent = 'Error loading';
            }
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('active');
            setTimeout(() => {
                errorMessage.classList.remove('active');
            }, 5000);
        }
        
        function showStatus(message) {
            statusText.textContent = message;
            statusSection.classList.add('active');
        }
        
        function hideStatus() {
            statusSection.classList.remove('active');
        }
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const message = document.getElementById('message').value.trim();
            const customNames = document.getElementById('customNames').value.trim();
            const duration = parseInt(document.getElementById('duration').value);
            const resolution = document.getElementById('resolution').value;
            const columns = parseInt(document.getElementById('columns').value);
            const nameAlign = document.getElementById('nameAlign').value;
            const truncateLength = parseInt(document.getElementById('truncateLength').value) || 0;
            const wordWrap = document.getElementById('wordWrap').checked;
            const nameSpacing = document.getElementById('nameSpacing').checked;
            const bgColor = document.getElementById('bgColor').value;
            const useCache = document.getElementById('useCache').checked;
            
            // Get styling options
            const messageStyle = {
                size: parseInt(document.getElementById('messageSize').value),
                color: document.getElementById('messageColor').value,
                font: document.getElementById('messageFont').value,
                bold: document.getElementById('messageBold').checked,
                align: document.getElementById('messageAlign').value
            };

            const patronStyle = {
                size: parseInt(document.getElementById('patronSize').value),
                color: document.getElementById('patronColor').value,
                font: document.getElementById('patronFont').value,
                bold: document.getElementById('patronBold').checked
            };
            
            if (!message) {
                showError('Please enter a message');
                return;
            }
            
            generateBtn.disabled = true;
            showStatus('Fetching patron list...');
            
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message,
                        custom_names: customNames,
                        duration,
                        resolution,
                        columns,
                        name_align: nameAlign,
                        truncate_length: truncateLength,
                        word_wrap: wordWrap,
                        name_spacing: nameSpacing,
                        bg_color: bgColor,
                        use_cache: useCache,
                        message_style: messageStyle,
                        patron_style: patronStyle
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to generate video');
                }
                
                showStatus('Video generated successfully!');
                
                // Show video preview
                videoPlayer.src = data.video_url;
                videoPreview.classList.add('active');
                
                // Store filename for download handler
                downloadBtn.dataset.filename = data.filename;
                
                // Update patron count
                patronCount.textContent = data.patron_count;
                
                setTimeout(hideStatus, 2000);
                
            } catch (error) {
                showError(error.message);
                hideStatus();
            } finally {
                generateBtn.disabled = false;
            }
        });
        
        document.getElementById('namesFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                let text = reader.result;
                // CSV: if lines contain commas, split on commas and flatten
                if (file.name.endsWith('.csv')) {
                    const names = text.split(/[\r\n]+/)
                        .flatMap(line => line.split(','))
                        .map(n => n.trim().replace(/^["']|["']$/g, ''))
                        .filter(Boolean);
                    text = names.join('\n');
                }
                const ta = document.getElementById('customNames');
                ta.value = ta.value ? ta.value.trimEnd() + '\n' + text.trim() : text.trim();
                saveSettings();
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        // In desktop mode, hide Download and show Open Folder instead
        if (isDesktop) {
            downloadBtn.style.display = 'none';
            openFolderBtn.style.display = 'inline-block';
        }

        downloadBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const filename = downloadBtn.dataset.filename;
            if (!filename) return;
            try {
                const resp = await fetch(`/download/${filename}`);
                if (!resp.ok) throw new Error('Download failed');
                const blob = await resp.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `patreon_credits_${filename}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (err) {
                showError(err.message);
            }
        });

        openFolderBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                const resp = await fetch('/open-output-folder', { method: 'POST' });
                const data = await resp.json();
                if (!data.success) showError(data.error || 'Failed to open folder');
            } catch (err) {
                showError(err.message);
            }
        });

        refreshBtn.addEventListener('click', async () => {
            refreshBtn.disabled = true;
            showStatus('Refreshing patron list...');

            try {
                const response = await fetch('/refresh-patrons', { method: 'POST' });
                const data = await response.json();

                if (data.error) {
                    showError('Error: ' + data.error);
                } else {
                    showStatus('Patron list refreshed: ' + data.count + ' patrons.');
                    patronCount.textContent = data.count;
                    setTimeout(hideStatus, 2000);
                }
            } catch (error) {
                showError('Failed to refresh patron list');
                hideStatus();
            } finally {
                refreshBtn.disabled = false;
            }
        });
    </script>
</body>
</html>