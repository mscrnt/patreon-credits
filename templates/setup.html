<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patreon Credits Generator - Setup</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/theme.css">
    <link rel="stylesheet" href="/static/css/app.css">
    <script src="/static/js/theme.js"></script>
</head>
<body class="d-flex align-items-center justify-content-center min-vh-100">

    <div class="container" style="max-width:600px;">
        <h1 class="text-center mb-1">Welcome to Patreon Credits Generator</h1>
        <p class="text-center text-body-secondary mb-4">Let's get everything set up before you start.</p>

        <!-- FFmpeg -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="fa-solid fa-film me-1"></i>FFmpeg
                <span class="badge bg-secondary ms-2" id="ffmpegBadge">Checking...</span>
            </div>
            <div class="card-body">
                <p class="text-body-secondary small mb-2">FFmpeg is required to render credit videos.</p>
                <div id="ffmpegOk" class="d-none">
                    <p class="text-success mb-0">FFmpeg is installed and ready.</p>
                </div>
                <div id="ffmpegMissing" class="d-none">
                    <p class="text-danger mb-2">FFmpeg was not found on your system.</p>
                    <button class="btn btn-outline-secondary" id="installFfmpegBtn">
                        <i class="fa-solid fa-download me-1"></i>Download &amp; Install FFmpeg
                    </button>
                    <div class="settings-progress" id="ffmpegProgress">
                        <div class="progress" style="height:6px;">
                            <div class="progress-bar" id="ffmpegProgressFill" style="width:0%"></div>
                        </div>
                    </div>
                    <div class="alert d-none mt-2" id="ffmpegMsg"></div>
                </div>
            </div>
        </div>

        <!-- Patreon Credentials -->
        <div class="card mb-3">
            <div class="card-header"><i class="fa-solid fa-key me-1"></i>Patreon Credentials</div>
            <div class="card-body">
                <p class="text-body-secondary small mb-3">
                    Enter your Creator Access Token to connect to Patreon.
                    <a href="https://www.patreon.com/portal/registration/register-clients" target="_blank" rel="noopener">Get your token</a>
                </p>

                <label class="form-label" for="patreonToken">Creator Access Token</label>
                <div class="input-group mb-2">
                    <input type="password" class="form-control" id="patreonToken" placeholder="Paste your token here">
                    <button class="btn btn-outline-secondary" id="detectBtn">Detect Campaign</button>
                </div>
                <div class="form-text mb-3">Your token is stored locally and never sent anywhere except Patreon's API.</div>

                <label class="form-label">Campaign ID</label>
                <input type="text" class="form-control mb-2" id="campaignId" placeholder="Auto-detected when you click Detect Campaign">

                <div class="alert d-none mt-2" id="patreonMsg"></div>

                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="useDummyData">
                    <label class="form-check-label" for="useDummyData">Use dummy data (no Patreon account needed)</label>
                </div>
            </div>
        </div>

        <!-- Save & Continue -->
        <button class="btn btn-success w-100 mb-2" id="saveBtn">
            <i class="fa-solid fa-check me-1"></i>Save &amp; Open App
        </button>
        <div class="alert d-none mt-2" id="saveMsg"></div>

        <a href="/" class="d-block text-center text-body-secondary mt-2 text-decoration-none small">Skip setup (use defaults)</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ---- FFmpeg ----
        async function checkFfmpeg() {
            try {
                const resp = await fetch('/check-ffmpeg');
                const data = await resp.json();
                const badge = document.getElementById('ffmpegBadge');
                if (data.installed) {
                    badge.textContent = 'Installed';
                    badge.className = 'badge bg-success';
                    document.getElementById('ffmpegOk').classList.remove('d-none');
                    document.getElementById('ffmpegMissing').classList.add('d-none');
                } else {
                    badge.textContent = 'Not Found';
                    badge.className = 'badge bg-danger';
                    document.getElementById('ffmpegOk').classList.add('d-none');
                    document.getElementById('ffmpegMissing').classList.remove('d-none');
                }
            } catch (_) {
                document.getElementById('ffmpegBadge').textContent = 'Error';
                document.getElementById('ffmpegBadge').className = 'badge bg-danger';
            }
        }

        document.getElementById('installFfmpegBtn').addEventListener('click', async function () {
            const btn = this;
            const progress = document.getElementById('ffmpegProgress');
            const fill = document.getElementById('ffmpegProgressFill');
            const msg = document.getElementById('ffmpegMsg');

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Downloading...';
            progress.classList.add('active');
            fill.style.width = '30%';
            msg.className = 'alert d-none';

            try {
                const resp = await fetch('/install-ffmpeg', { method: 'POST' });
                const data = await resp.json();
                fill.style.width = '100%';
                if (data.success) {
                    msg.className = 'alert alert-success mt-2';
                    msg.textContent = 'FFmpeg installed successfully!';
                    setTimeout(checkFfmpeg, 500);
                } else {
                    msg.className = 'alert alert-danger mt-2';
                    msg.textContent = data.error || 'Installation failed.';
                    btn.disabled = false;
                    btn.textContent = 'Retry Download';
                }
            } catch (e) {
                fill.style.width = '0%';
                msg.className = 'alert alert-danger mt-2';
                msg.textContent = 'Network error: ' + e.message;
                btn.disabled = false;
                btn.textContent = 'Retry Download';
            }
        });

        // ---- Campaign detection ----
        document.getElementById('detectBtn').addEventListener('click', async function () {
            const token = document.getElementById('patreonToken').value.trim();
            const msg = document.getElementById('patreonMsg');
            const btn = this;
            if (!token) {
                msg.className = 'alert alert-danger mt-2';
                msg.textContent = 'Please enter your Patreon token first.';
                return;
            }
            btn.disabled = true;
            btn.textContent = 'Detecting...';
            msg.className = 'alert d-none';

            try {
                const resp = await fetch('/detect-campaign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                const data = await resp.json();
                if (data.campaign_id) {
                    document.getElementById('campaignId').value = data.campaign_id;
                    msg.className = 'alert alert-success mt-2';
                    msg.textContent = 'Campaign detected: ' + data.campaign_id;
                } else {
                    msg.className = 'alert alert-danger mt-2';
                    msg.textContent = data.error || 'Could not detect campaign.';
                }
            } catch (e) {
                msg.className = 'alert alert-danger mt-2';
                msg.textContent = 'Network error: ' + e.message;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Detect Campaign';
            }
        });

        // ---- Save & continue ----
        document.getElementById('saveBtn').addEventListener('click', async function () {
            const btn = this;
            const msg = document.getElementById('saveMsg');
            btn.disabled = true;

            const payload = {
                patreon_token: document.getElementById('patreonToken').value.trim(),
                campaign_id: document.getElementById('campaignId').value.trim(),
                use_dummy_data: document.getElementById('useDummyData').checked,
            };

            try {
                const resp = await fetch('/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if (data.success) {
                    msg.className = 'alert alert-success mt-2';
                    msg.textContent = 'Settings saved! Redirecting...';
                    setTimeout(function () { window.location.href = '/'; }, 800);
                } else {
                    msg.className = 'alert alert-danger mt-2';
                    msg.textContent = data.error || 'Failed to save.';
                    btn.disabled = false;
                }
            } catch (e) {
                msg.className = 'alert alert-danger mt-2';
                msg.textContent = 'Error: ' + e.message;
                btn.disabled = false;
            }
        });

        // ---- Load existing values ----
        async function loadExisting() {
            try {
                const resp = await fetch('/settings', { headers: { 'Accept': 'application/json' } });
                const data = await resp.json();
                if (data.patreon_token) document.getElementById('patreonToken').value = data.patreon_token;
                if (data.campaign_id) document.getElementById('campaignId').value = data.campaign_id;
                if (data.use_dummy_data) document.getElementById('useDummyData').checked = true;
            } catch (_) {}
        }

        checkFfmpeg();
        loadExisting();
    </script>
</body>
</html>
